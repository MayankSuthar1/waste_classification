<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Classification - SqueezeNet + XGBoost</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }
        
        #fileInput {
            display: none;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        #imagePreview {
            display: none;
            margin: 30px 0;
            text-align: center;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #results {
            display: none;
            margin-top: 30px;
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .predicted-class {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .confidence {
            font-size: 1.3em;
            color: #666;
        }
        
        .confidence-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .probabilities {
            margin-top: 30px;
        }
        
        .probability-item {
            margin: 15px 0;
        }
        
        .probability-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .probability-bar {
            width: 100%;
            height: 25px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .probability-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.5s ease;
            border-radius: 12px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .button-secondary {
            background: #fff;
            color: #667eea;
            border: 2px solid #667eea;
            margin: 0 10px;
        }
        
        .button-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .button-camera {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .button-camera:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }
        
        #cameraModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .camera-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }
        
        #video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            background: #000;
        }
        
        #canvas {
            display: none;
        }
        
        .camera-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .close-camera {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f5576c;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
        }
        
        footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.9;
        }
        
        footer a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ôªÔ∏è Waste Classification</h1>
            <p>AI-Powered Waste Sorting using SqueezeNet & XGBoost</p>
        </header>
        
        <div class="card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <div class="upload-text">Click to upload or drag and drop</div>
                <div class="upload-hint">Supported formats: JPG, PNG, BMP (Max 16MB)</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            
            <div class="button-group">
                <button class="button button-camera" onclick="openCamera()">
                    üì∑ Take Photo with Camera
                </button>
                <button class="button button-secondary" onclick="triggerMobileCamera()" style="display: none;" id="mobileCameraBtn">
                    üì± Use Phone Camera
                </button>
            </div>
            <input type="file" id="mobileCameraInput" accept="image/*" capture="environment" style="display: none;">
            
            <div id="imagePreview">
                <img id="previewImage" src="" alt="Preview">
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing image...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div id="results">
                <div class="result-header">
                    <h2>Classification Result</h2>
                    <div class="predicted-class" id="predictedClass"></div>
                    <div class="confidence" id="confidenceText"></div>
                </div>
                
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
                
                <div class="probabilities">
                    <h3>All Class Probabilities</h3>
                    <div id="probabilitiesList"></div>
                </div>
                
                <div class="actions">
                    <button class="button button-secondary" onclick="classifyAnother()">
                        Classify Another Image
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Powered by SqueezeNet & XGBoost | 
                <a href="/about">About</a> | 
                <a href="/api/health">API Status</a>
            </p>
        </footer>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal">
        <div class="camera-container">
            <button class="close-camera" onclick="closeCamera()">√ó</button>
            <h2 style="text-align: center; margin-bottom: 20px;">üì∑ Capture Waste Image</h2>
            <div id="cameraError" style="display: none; background: #fee; color: #c33; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; white-space: pre-line;"></div>
            <div id="cameraSelector" style="margin-bottom: 15px; text-align: center; display: none;">
                <label for="cameraSelect" style="margin-right: 10px; font-weight: 500;">Select Camera:</label>
                <select id="cameraSelect" onchange="switchCamera()" style="padding: 8px; border-radius: 5px; border: 2px solid #667eea; font-size: 1em;">
                </select>
            </div>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="camera-controls">
                <button class="button" onclick="capturePhoto()">üì∏ Capture Photo</button>
                <button class="button button-secondary" onclick="closeCamera()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        
        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selection
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        
        function handleFile(file) {
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                imagePreview.style.display = 'block';
                uploadArea.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // Upload and classify
            uploadAndClassify(file);
        }
        
        function uploadAndClassify(file) {
            // Hide previous results and errors
            results.style.display = 'none';
            error.style.display = 'none';
            loading.style.display = 'block';
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            // Send to server
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    displayResults(data);
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                showError('An error occurred: ' + err.message);
            });
        }
        
        function displayResults(data) {
            // Display predicted class
            document.getElementById('predictedClass').textContent = 
                data.predicted_class.toUpperCase();
            
            // Display confidence
            const confidence = (data.confidence * 100).toFixed(2);
            document.getElementById('confidenceText').textContent = 
                `Confidence: ${confidence}%`;
            
            // Update confidence bar
            const confidenceFill = document.getElementById('confidenceFill');
            confidenceFill.style.width = confidence + '%';
            confidenceFill.textContent = confidence + '%';
            
            // Display all probabilities
            const probabilitiesList = document.getElementById('probabilitiesList');
            probabilitiesList.innerHTML = '';
            
            // Sort probabilities
            const sortedProbs = Object.entries(data.probabilities)
                .sort((a, b) => b[1] - a[1]);
            
            sortedProbs.forEach(([className, prob]) => {
                const percentage = (prob * 100).toFixed(2);
                const item = document.createElement('div');
                item.className = 'probability-item';
                item.innerHTML = `
                    <div class="probability-label">
                        <span>${className}</span>
                        <span>${percentage}%</span>
                    </div>
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                probabilitiesList.appendChild(item);
            });
            
            // Show results
            results.style.display = 'block';
        }
        
        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }
        
        function classifyAnother() {
            // Reset everything
            imagePreview.style.display = 'none';
            results.style.display = 'none';
            error.style.display = 'none';
            uploadArea.style.display = 'block';
            fileInput.value = '';
        }
        
        // Camera functionality
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraModal = document.getElementById('cameraModal');
        
        async function openCamera() {
            try {
                // First, check if mediaDevices is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported in this browser');
                }
                
                // Try to request camera first - this may prompt for permission
                // which then allows enumerateDevices to show device labels
                let tempStream;
                try {
                    tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // Stop it immediately, we just needed permission
                    tempStream.getTracks().forEach(track => track.stop());
                } catch (permErr) {
                    console.log('Initial permission request:', permErr.message);
                }
                
                // Now try to get list of available devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('All devices:', devices);
                console.log('Video devices found:', videoDevices);
                
                if (videoDevices.length === 0) {
                    // No camera detected - offer alternative
                    showNoCameraDialog();
                    return;
                }
                
                console.log('Available cameras:', videoDevices.length);
                
                // Try multiple constraint configurations
                let constraints;
                
                // Try 1: Environment camera with flexible constraints
                try {
                    constraints = { 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (e) {
                    console.log('Environment camera not available, trying user camera...');
                    
                    // Try 2: User (front) camera
                    try {
                        constraints = { 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, min: 640 },
                                height: { ideal: 720, min: 480 }
                            } 
                        };
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (e2) {
                        console.log('Specific camera not available, trying any camera...');
                        
                        // Try 3: Any available camera with basic constraints
                        try {
                            constraints = { 
                                video: {
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            };
                            stream = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch (e3) {
                            console.log('Trying simplest constraints...');
                            
                            // Try 4: Simplest possible - just request video
                            constraints = { video: true };
                            stream = await navigator.mediaDevices.getUserMedia(constraints);
                        }
                    }
                }
                
                // If we got here, we have a stream!
                video.srcObject = stream;
                cameraModal.style.display = 'flex';
                
                console.log('Camera opened successfully!');
                console.log('Stream settings:', stream.getVideoTracks()[0].getSettings());
                
                // Populate camera selector if multiple cameras available
                await populateCameraSelector();
                
            } catch (err) {
                console.error('Camera error:', err);
                let errorMessage = 'Unable to access camera: ' + err.message;
                
                // Provide specific guidance based on error
                if (err.name === 'NotFoundError' || err.message.includes('not found')) {
                    errorMessage += '\n\nTroubleshooting:\n';
                    errorMessage += '‚Ä¢ Make sure your camera is connected and not in use by another application\n';
                    errorMessage += '‚Ä¢ Try closing other apps that might be using the camera (Zoom, Teams, Skype)\n';
                    errorMessage += '‚Ä¢ Restart your browser and try again';
                } else if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += '\n\nCamera permission denied. Please:\n';
                    errorMessage += '‚Ä¢ Click the camera icon in your browser address bar\n';
                    errorMessage += '‚Ä¢ Select "Always allow" for camera access\n';
                    errorMessage += '‚Ä¢ Refresh the page and try again';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += '\n\nCamera is in use by another application.\n';
                    errorMessage += 'Please close other apps using the camera.';
                }
                
                showError(errorMessage);
            }
        }
        
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraModal.style.display = 'none';
            document.getElementById('cameraError').style.display = 'none';
            document.getElementById('cameraSelector').style.display = 'none';
        }
        
        // Populate camera selector with available devices
        async function populateCameraSelector() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length > 1) {
                    const selector = document.getElementById('cameraSelect');
                    selector.innerHTML = '';
                    
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${index + 1}`;
                        selector.appendChild(option);
                    });
                    
                    document.getElementById('cameraSelector').style.display = 'block';
                    return videoDevices;
                }
            } catch (err) {
                console.error('Error enumerating devices:', err);
            }
            return [];
        }
        
        // Switch to a different camera
        async function switchCamera() {
            const deviceId = document.getElementById('cameraSelect').value;
            
            // Stop current stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            try {
                // Start new stream with selected device
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    }
                });
                
                video.srcObject = stream;
                console.log('Switched to camera:', deviceId);
            } catch (err) {
                console.error('Error switching camera:', err);
                showCameraError('Failed to switch camera: ' + err.message);
            }
        }
        
        function showCameraError(message) {
            const errorDiv = document.getElementById('cameraError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function capturePhoto() {
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob
            canvas.toBlob((blob) => {
                if (blob) {
                    // Create a file from blob
                    const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                    
                    // Close camera
                    closeCamera();
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        imagePreview.style.display = 'block';
                        uploadArea.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                    
                    // Upload and classify
                    uploadAndClassify(file);
                }
            }, 'image/jpeg', 0.95);
        }
        
        // Mobile camera fallback (uses native camera app)
        const mobileCameraInput = document.getElementById('mobileCameraInput');
        
        function triggerMobileCamera() {
            mobileCameraInput.click();
        }
        
        mobileCameraInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Show dialog when no camera is found
        function showNoCameraDialog() {
            const message = `No camera detected on your device.

Options:
1. Check if camera is connected and enabled
2. Close other apps using the camera (Zoom, Teams, etc.)
3. Restart your browser
4. Use "Click to upload" to select an existing photo

On Mobile:
‚Ä¢ Use the "üì± Use Phone Camera" button below
‚Ä¢ This opens your phone's native camera app

On Desktop:
‚Ä¢ Make sure your webcam is connected
‚Ä¢ Enable camera in Device Manager (Windows)
‚Ä¢ Check System Preferences (Mac)`;
            
            alert(message);
            
            // Show mobile camera button as alternative
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('mobileCameraBtn').style.display = 'inline-block';
            }
        }
        
        // Detect if mobile and show appropriate button
        window.addEventListener('load', () => {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                // On mobile, show the mobile camera button
                document.getElementById('mobileCameraBtn').style.display = 'inline-block';
            }
        });
        
        // Close camera when clicking outside the modal
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) {
                closeCamera();
            }
        });
    </script>
</body>
</html>
